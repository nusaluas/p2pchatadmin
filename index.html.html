<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Obrolan Lokal (P2P)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease-in-out;
            /* Latar belakang gradasi futuristik */
            background: linear-gradient(135deg, #001f3f 0%, #1f4287 50%, #2f61a4 100%);
        }
        #chat-messages::-webkit-scrollbar,
        #contact-list::-webkit-scrollbar {
            width: 8px;
        }
        #chat-messages::-webkit-scrollbar-track,
        #contact-list::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        #chat-messages::-webkit-scrollbar-thumb,
        #contact-list::-webkit-scrollbar-thumb {
            background: #a8a8a8;
            border-radius: 4px;
        }
        .message-bubble {
            max-width: 95%;
            word-wrap: break-word;
            word-break: break-all;
        }
        .status-dot {
            height: 10px;
            width: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .bg-online { background-color: #22c55e; }
        .bg-connecting { background-color: #f97316; }
        .bg-offline { background-color: #ef4444; }
        .emoji-picker {
            position: absolute;
            bottom: 100px;
            right: 16px;
            width: 250px;
            max-height: 300px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 12px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            z-index: 10;
        }
        .emoji-picker span {
            cursor: pointer;
            font-size: 24px;
            text-align: center;
            transition: transform 0.1s ease-in-out;
        }
        .emoji-picker span:hover {
            transform: scale(1.2);
        }
        .contact-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .contact-item:hover {
            background-color: #f0fdf4;
        }
        .contact-item.active {
            background-color: #d1fae5;
            border-left: 4px solid #047857;
        }
        .file-preview {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-top: 8px;
        }
        /* Video Container */
        #video-container {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 20;
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            pointer-events: none;
        }
        #video-container.active {
            opacity: 1;
            pointer-events: auto;
        }
        #local-video {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 150px;
            height: auto;
            border-radius: 8px;
            border: 2px solid white;
            z-index: 25;
        }
        #remote-video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center h-screen p-4">

    <!-- Kontainer Utama -->
    <div class="w-full max-w-5xl h-full md:h-[90vh] flex bg-white shadow-2xl rounded-xl overflow-hidden relative">
        
        <!-- Sidebar Daftar Kontak -->
        <div class="w-1/3 flex flex-col border-r border-gray-200">
            <!-- Header Sidebar -->
            <header class="bg-teal-600 text-white p-3 shadow-md flex-shrink-0">
                <h2 class="text-xl font-bold text-center">Kontak Saya</h2>
                <div class="mt-2 text-center bg-teal-700 p-2 rounded-lg text-sm">
                    <span class="font-semibold text-teal-200">ID Anda:</span>
                    <span id="my-id" class="font-mono bg-white text-teal-800 px-2 py-1 rounded-md text-xs">Memuat...</span>
                    <button id="copy-id-btn" class="bg-teal-500 hover:bg-teal-400 text-white text-xs font-semibold px-2 py-1 rounded-md transition-all duration-200 ml-2">
                        Salin
                    </button>
                </div>
            </header>

            <!-- Daftar Kontak Aktif -->
            <ul id="contact-list" class="flex-1 overflow-y-auto bg-gray-50">
                <li class="p-4 text-center text-gray-500 italic">Tidak ada obrolan.</li>
            </ul>

            <!-- Area Koneksi & Nama Pengguna di Sidebar -->
            <div class="p-3 border-t border-gray-200 flex-shrink-0">
                <form id="connect-form" class="flex items-center space-x-2">
                    <input type="text" id="peer-id-input" placeholder="ID teman Anda" class="flex-1 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500 text-sm">
                    <button type="submit" class="bg-teal-500 text-white px-3 py-2 rounded-md hover:bg-teal-600 transition-colors duration-200 text-sm">Hubungkan</button>
                </form>

                <div class="flex flex-col sm:flex-row items-center justify-center space-y-2 sm:space-y-0 sm:space-x-4 mt-2">
                    <input type="text" id="username-input" placeholder="Nama pengguna Anda" class="flex-1 p-1 w-full sm:w-auto border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500 text-gray-800 text-sm">
                    <button id="save-username-btn" class="bg-teal-500 hover:bg-teal-400 text-white text-xs font-semibold px-3 py-1 rounded-md transition-all duration-200 w-full sm:w-auto">
                        Simpan Nama
                    </button>
                </div>
                <div id="username-display" class="font-semibold text-teal-100 text-xs mt-1 text-center"></div>
            </div>
            
            <!-- Tombol Admin Login -->
            <div class="p-3 border-t border-gray-200 flex-shrink-0">
                <button id="admin-login-btn" class="bg-gray-800 text-white w-full py-2 rounded-md hover:bg-gray-700 transition-colors duration-200 text-sm">
                    Admin Login
                </button>
            </div>
        </div>

        <!-- Area Obrolan Utama -->
        <div class="w-2/3 flex flex-col">
            <!-- Header Obrolan - Diperbarui untuk Tombol Keluar dan Hapus Riwayat -->
            <header id="chat-header" class="bg-gray-100 text-gray-800 p-3 shadow-sm flex-shrink-0 flex items-center justify-between">
                <div id="status" class="text-center text-gray-500 text-xs h-4 flex items-center justify-start">
                    <span id="chat-status-dot" class="status-dot bg-offline"></span>
                    <span id="chat-status-text">Tidak ada obrolan aktif.</span>
                </div>
                <div class="flex space-x-2">
                    <!-- Tombol Panggilan Video -->
                    <button id="video-call-btn" class="bg-purple-500 text-white p-1 rounded-md hover:bg-purple-600 text-xs font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M17 10.5V7c0-.6-.4-1-1-1H4c-.6 0-1 .4-1 1v10c0 .6.4 1 1 1h12c.6 0 1-.4 1-1v-3.5l4 4v-11l-4 4z"/>
                        </svg>
                    </button>
                    <!-- Tombol Panggilan Suara -->
                    <button id="call-btn" class="bg-blue-500 text-white p-1 rounded-md hover:bg-blue-600 text-xs font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M20 15.5c-1.1 0-2.1.2-3.1.5l-1.5-1.5c-2.8 2.2-4.6 4-6.3 6.3l1.5 1.5c-.3 1-.5 2-.5 3.1 0 2.2 1.8 4 4 4h.5c1.4 0 2.7-.4 3.8-1.1.2-.1.4-.2.5-.3.4-.3.7-.6 1-.9.6-.6 1.2-1.2 1.8-1.8.8-.8 1.4-1.7 1.8-2.6.2-.4.4-.8.5-1.3.1-.4.2-.8.2-1.3V18c0-.6-.4-1-1-1zm-1-3.5h-2v3c0 .6-.4 1-1 1h-1v-4h-2V6h4v1h2v-2c0-.6-.4-1-1-1h-5c-.6 0-1 .4-1 1v6c0 .6.4 1 1 1h2c.6 0 1 .4 1 1v2c0 .6.4 1 1 1h1c.6 0 1-.4 1-1v-3h1z"/>
                        </svg>
                    </button>
                     <!-- Tombol Tutup Panggilan -->
                    <button id="hangup-btn" class="bg-red-500 text-white p-1 rounded-md hover:bg-red-600 text-xs font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M21 16.9v3.1c0 .6-.4 1-1 1H4c-.6 0-1-.4-1-1v-3.1c0-.4.3-.8.6-.9l4.8-1.7c.3-.1.7 0 1 .3l2.3 2.3c.7.7 1.9.7 2.6 0l2.3-2.3c.3-.3.7-.4 1-.3l4.8 1.7c.3.1.6.5.6.9zm-4.7-6.2l-2.6-2.6c-.7-.7-1.9-.7-2.6 0l-2.6 2.6c-.3.3-.7.4-1 .3L3 9.4c-.4-.1-.7-.5-.7-.9V4c0-.6.4-1 1-1h16c.6 0 1 .4 1 1v4.5c0 .4-.3.8-.6.9l-4.8 1.7c-.3.1-.7 0-1-.3z"/>
                        </svg>
                    </button>
                    <!-- Tombol baru untuk menghapus riwayat -->
                     <button id="clear-history-btn" class="bg-gray-500 text-white px-3 py-1 rounded-md hover:bg-gray-600 text-xs font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed hidden">
                        Hapus Riwayat
                    </button>
                    <!-- Tombol Keluar untuk mengakhiri obrolan saat ini -->
                    <button id="exit-chat-btn" class="bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600 text-xs font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed hidden">
                        Keluar
                    </button>
                </div>
            </header>

            <!-- Kotak Pesan -->
            <main id="chat-messages" class="flex-1 p-4 overflow-y-auto bg-gray-50">
                <div class="text-center text-gray-500 text-sm">Pilih obrolan dari daftar kontak.</div>
            </main>
            <!-- Elemen Audio untuk aliran jarak jauh -->
            <audio id="remote-audio" autoplay class="hidden"></audio>

            <!-- Input Pesan -->
            <footer class="p-3 bg-white border-t border-gray-200 flex-shrink-0">
                <form id="message-form" class="flex items-center space-x-2 relative">
                    <button type="button" id="emoji-btn" class="text-2xl p-1 rounded-full hover:bg-gray-200 transition-colors duration-200 disabled:bg-gray-100 disabled:cursor-not-allowed" disabled>
                        ðŸ˜Š
                    </button>
                    <input type="text" id="message-input" placeholder="Ketik pesan Anda..." autocomplete="off" class="flex-1 p-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-teal-500 disabled:bg-gray-100 text-sm" disabled>
                    <label for="file-input" class="bg-gray-200 hover:bg-gray-300 text-gray-600 p-2 rounded-full cursor-pointer transition-colors duration-200 disabled:bg-gray-100 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6zM6 4h7v4h4v12H6V4zm10 14h-4a1 1 0 010-2h4a1 1 0 010 2z"/>
                        </svg>
                    </label>
                    <input type="file" id="file-input" class="hidden" disabled>
                    <button type="submit" class="bg-teal-600 text-white p-2 rounded-full hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2 transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
                        </svg>
                    </button>
                </form>
            </footer>
        </div>

        <!-- Kontainer Video Call -->
        <div id="video-container" class="hidden">
            <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" muted autoplay playsinline></video>
        </div>

        <!-- Pemilih Emoji -->
        <div id="emoji-picker" class="emoji-picker hidden"></div>
    </div>

    <!-- Kotak pesan kustom untuk notifikasi -->
    <div id="custom-message-box" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <h3 id="message-box-title" class="font-bold text-lg mb-2 text-gray-800">Pemberitahuan</h3>
            <p id="message-box-content" class="text-sm text-gray-600 mb-4">Pesan Anda di sini.</p>
            <div class="flex justify-end">
                <button id="message-box-close-btn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-md">Tutup</button>
            </div>
        </div>
    </div>
    
    <!-- Kotak konfirmasi kustom untuk panggilan masuk -->
    <div id="call-dialog" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
            <h3 id="call-dialog-title" class="font-bold text-lg mb-2 text-gray-800">Panggilan Masuk</h3>
            <p id="call-dialog-content" class="text-sm text-gray-600 mb-4">Menerima panggilan dari [Nama]...</p>
            <div class="flex justify-center space-x-4">
                <button id="answer-call-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md">Terima</button>
                <button id="decline-call-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md">Tolak</button>
            </div>
        </div>
    </div>

    <!-- Modal Admin Login -->
    <div id="admin-login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <h3 class="font-bold text-lg mb-4 text-gray-800">Login Admin</h3>
            <p class="text-sm text-gray-600 mb-4">Kata sandi admin adalah: **admin123**</p>
            <form id="admin-login-form" class="flex flex-col space-y-4">
                <input type="password" id="admin-password-input" placeholder="Masukkan kata sandi..." class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500 text-sm">
                <button type="submit" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-md">Login</button>
            </form>
            <div class="flex justify-end mt-4">
                <button id="admin-login-close-btn" class="text-gray-500 hover:text-gray-700 font-bold py-2 px-4 rounded-md">Tutup</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Admin Panel -->
    <div id="admin-panel" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-lg w-full">
            <h3 class="font-bold text-lg mb-4 text-gray-800">Panel Admin</h3>
            <div class="max-h-96 overflow-y-auto">
                <h4 class="font-semibold text-gray-700 mb-2">Pengguna yang disetujui:</h4>
                <ul id="approved-users-list" class="space-y-2">
                    <li class="p-2 bg-gray-100 rounded-md text-sm text-gray-500 italic">Tidak ada pengguna yang disetujui.</li>
                </ul>
                <h4 class="font-semibold text-gray-700 mt-4 mb-2">Tambah ID untuk disetujui:</h4>
                <form id="add-approved-id-form" class="flex space-x-2">
                    <input type="text" id="new-approved-id-input" placeholder="ID pengguna baru" class="flex-1 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500 text-sm">
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold px-4 py-2 rounded-md text-sm">Tambah</button>
                </form>
            </div>
            <div class="flex justify-end mt-4">
                <button id="admin-panel-close-btn" class="text-gray-500 hover:text-gray-700 font-bold py-2 px-4 rounded-md">Tutup</button>
            </div>
        </div>
    </div>


    <script>
        // Memastikan kode dieksekusi setelah semua elemen DOM dimuat
        document.addEventListener('DOMContentLoaded', () => {
            // Ambil referensi elemen-elemen DOM
            const myIdSpan = document.getElementById('my-id');
            const copyIdBtn = document.getElementById('copy-id-btn');
            const usernameInput = document.getElementById('username-input');
            const saveUsernameBtn = document.getElementById('save-username-btn');
            const usernameDisplay = document.getElementById('username-display');
            const connectForm = document.getElementById('connect-form');
            const peerIdInput = document.getElementById('peer-id-input');
            const messageForm = document.getElementById('message-form');
            const messageInput = document.getElementById('message-input');
            const sendButton = messageForm.querySelector('button[type="submit"]');
            const emojiBtn = document.getElementById('emoji-btn');
            const emojiPicker = document.getElementById('emoji-picker');
            const chatMessages = document.getElementById('chat-messages');
            const chatHeader = document.getElementById('chat-header');
            const chatStatusDot = document.getElementById('chat-status-dot');
            const chatStatusText = document.getElementById('chat-status-text');
            const exitChatBtn = document.getElementById('exit-chat-btn');
            const clearHistoryBtn = document.getElementById('clear-history-btn');
            const callBtn = document.getElementById('call-btn');
            const videoCallBtn = document.getElementById('video-call-btn'); // Tombol Panggilan Video baru
            const hangupBtn = document.getElementById('hangup-btn');
            const remoteAudio = document.getElementById('remote-audio');
            const remoteVideo = document.getElementById('remote-video'); // Elemen Video Jarak Jauh
            const localVideo = document.getElementById('local-video'); // Elemen Video Lokal
            const videoContainer = document.getElementById('video-container'); // Kontainer Video
            const contactList = document.getElementById('contact-list');
            const messageBox = document.getElementById('custom-message-box');
            const messageBoxTitle = document.getElementById('message-box-title');
            const messageBoxContent = document.getElementById('message-box-content');
            const messageBoxCloseBtn = document.getElementById('message-box-close-btn');
            const fileInput = document.getElementById('file-input');
            
            // Elemen dialog panggilan masuk
            const callDialog = document.getElementById('call-dialog');
            const callDialogTitle = document.getElementById('call-dialog-title');
            const callDialogContent = document.getElementById('call-dialog-content');
            const answerCallBtn = document.getElementById('answer-call-btn');
            const declineCallBtn = document.getElementById('decline-call-btn');

            // Elemen Admin
            const adminLoginBtn = document.getElementById('admin-login-btn');
            const adminLoginModal = document.getElementById('admin-login-modal');
            const adminLoginCloseBtn = document.getElementById('admin-login-close-btn');
            const adminLoginForm = document.getElementById('admin-login-form');
            const adminPasswordInput = document.getElementById('admin-password-input');
            const adminPanel = document.getElementById('admin-panel');
            const adminPanelCloseBtn = document.getElementById('admin-panel-close-btn');
            const approvedUsersList = document.getElementById('approved-users-list');
            const addApprovedIdForm = document.getElementById('add-approved-id-form');
            const newApprovedIdInput = document.getElementById('new-approved-id-input');

            let peer = null;
            let myUsername = 'Anda';
            let activeChats = new Map();
            let currentChatId = null;
            let localStream = null;
            let currentCall = null;
            let isVideoCall = false;

            // --- Fungsionalitas Daftar Kontak & Riwayat Obrolan ---
            const CONTACTS_STORAGE_KEY = 'p2pChatContacts';
            const CHAT_HISTORY_STORAGE_KEY = 'p2pChatHistory';
            const APPROVED_USERS_STORAGE_KEY = 'p2pApprovedUsers';
            let contacts = [];
            let chatHistory = new Map();
            let approvedUsers = [];

            function loadApprovedUsers() {
                const storedApproved = localStorage.getItem(APPROVED_USERS_STORAGE_KEY);
                if (storedApproved) {
                    try {
                        approvedUsers = JSON.parse(storedApproved);
                    } catch (e) {
                        console.error("Gagal memuat pengguna yang disetujui dari localStorage:", e);
                        approvedUsers = [];
                    }
                }
            }

            function saveApprovedUsers() {
                localStorage.setItem(APPROVED_USERS_STORAGE_KEY, JSON.stringify(approvedUsers));
            }

            function renderApprovedUsers() {
                approvedUsersList.innerHTML = '';
                if (approvedUsers.length === 0) {
                    const li = document.createElement('li');
                    li.textContent = 'Tidak ada pengguna yang disetujui.';
                    li.classList.add('p-2', 'bg-gray-100', 'rounded-md', 'text-sm', 'text-gray-500', 'italic');
                    approvedUsersList.appendChild(li);
                } else {
                    approvedUsers.forEach(user => {
                        const li = document.createElement('li');
                        li.classList.add('p-2', 'bg-gray-100', 'rounded-md', 'text-sm', 'font-mono', 'flex', 'justify-between', 'items-center');
                        li.textContent = user;
                        const removeBtn = document.createElement('button');
                        removeBtn.textContent = 'Hapus';
                        removeBtn.classList.add('bg-red-500', 'hover:bg-red-600', 'text-white', 'text-xs', 'px-2', 'py-1', 'rounded-md');
                        removeBtn.onclick = () => {
                            removeApprovedUser(user);
                        };
                        li.appendChild(removeBtn);
                        approvedUsersList.appendChild(li);
                    });
                }
            }

            function addApprovedUser(peerId) {
                if (!approvedUsers.includes(peerId)) {
                    approvedUsers.push(peerId);
                    saveApprovedUsers();
                    renderApprovedUsers();
                }
            }

            function removeApprovedUser(peerId) {
                approvedUsers = approvedUsers.filter(user => user !== peerId);
                saveApprovedUsers();
                renderApprovedUsers();
            }

            function loadContacts() {
                const storedContacts = localStorage.getItem(CONTACTS_STORAGE_KEY);
                if (storedContacts) {
                    try {
                        contacts = JSON.parse(storedContacts);
                        renderContacts();
                    } catch (e) {
                        console.error("Gagal memuat kontak dari localStorage:", e);
                        contacts = [];
                    }
                }
            }
            
            function saveContacts() {
                localStorage.setItem(CONTACTS_STORAGE_KEY, JSON.stringify(contacts));
            }

            function loadChatHistory() {
                const storedHistory = localStorage.getItem(CHAT_HISTORY_STORAGE_KEY);
                if (storedHistory) {
                    try {
                        const history = JSON.parse(storedHistory);
                        for (const peerId in history) {
                            if (history.hasOwnProperty(peerId)) {
                                chatHistory.set(peerId, history[peerId]);
                            }
                        }
                    } catch (e) {
                        console.error("Gagal memuat riwayat obrolan dari localStorage:", e);
                        chatHistory = new Map();
                    }
                }
            }

            function saveChatHistory(peerId, messages) {
                chatHistory.set(peerId, messages);
                localStorage.setItem(CHAT_HISTORY_STORAGE_KEY, JSON.stringify(Object.fromEntries(chatHistory)));
            }
            
            function clearChatHistory(peerId) {
                if (chatHistory.has(peerId)) {
                    chatHistory.delete(peerId);
                    localStorage.setItem(CHAT_HISTORY_STORAGE_KEY, JSON.stringify(Object.fromEntries(chatHistory)));
                    showCustomMessage('Riwayat Dihapus', `Riwayat obrolan dengan kontak ini telah dihapus.`);
                    
                    if (currentChatId === peerId) {
                        chatMessages.innerHTML = '';
                        const div = document.createElement('div');
                        div.classList.add('text-center', 'text-gray-500', 'text-sm');
                        div.textContent = 'Riwayat obrolan ini kosong.';
                        chatMessages.appendChild(div);
                    }
                }
            }

            function addContact(id, username) {
                if (contacts.some(contact => contact.id === id)) {
                    return;
                }
                contacts.push({ id, username });
                saveContacts();
                renderContacts();
            }

            function renderContacts() {
                contactList.innerHTML = '';
                if (contacts.length === 0) {
                    const li = document.createElement('li');
                    li.textContent = 'Tidak ada obrolan.';
                    li.classList.add('p-4', 'text-gray-500', 'italic', 'text-center');
                    contactList.appendChild(li);
                } else {
                    contacts.forEach(contact => {
                        const li = document.createElement('li');
                        li.classList.add('p-4', 'border-b', 'border-gray-200', 'flex', 'flex-col', 'items-start', 'space-y-1', 'last:border-b-0', 'contact-item');
                        li.dataset.peerId = contact.id;
                        li.innerHTML = `
                            <span class="text-sm font-semibold">${escapeHTML(contact.username || 'Anonim')}</span>
                            <span class="text-xs text-gray-400 font-mono">${escapeHTML(contact.id)}</span>
                        `;
                        contactList.appendChild(li);
                    });
                }
            }
            
            contactList.addEventListener('click', (e) => {
                const li = e.target.closest('li');
                if (li && li.dataset.peerId) {
                    switchActiveChat(li.dataset.peerId);
                }
            });

            loadContacts();
            loadChatHistory();
            loadApprovedUsers();

            // --- Fungsionalitas Admin ---
            adminLoginBtn.addEventListener('click', () => {
                adminLoginModal.classList.remove('hidden');
            });

            adminLoginCloseBtn.addEventListener('click', () => {
                adminLoginModal.classList.add('hidden');
            });
            
            adminPanelCloseBtn.addEventListener('click', () => {
                adminPanel.classList.add('hidden');
            });
            
            adminLoginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const password = adminPasswordInput.value;
                if (password === 'admin123') { // Kata sandi hardcode untuk demonstrasi
                    adminLoginModal.classList.add('hidden');
                    adminPanel.classList.remove('hidden');
                    renderApprovedUsers();
                    showCustomMessage('Login Berhasil', 'Anda telah masuk sebagai admin.');
                } else {
                    showCustomMessage('Login Gagal', 'Kata sandi salah.');
                }
                adminPasswordInput.value = '';
            });

            addApprovedIdForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newId = newApprovedIdInput.value.trim();
                if (newId) {
                    addApprovedUser(newId);
                    newApprovedIdInput.value = '';
                    showCustomMessage('Pengguna Disetujui', `ID ${newId} telah ditambahkan ke daftar yang disetujui.`);
                }
            });

            // --- Fungsionalitas Emoji ---
            const emojis = [
                'ðŸ˜€', 'ðŸ˜‚', 'ðŸ˜', 'ðŸ˜Ž', 'ðŸ˜œ', 'ðŸ‘', 'ðŸ™', 'â¤ï¸', 'ðŸ”¥', 'ðŸŽ‰', 'ðŸš€', 'ðŸŒŸ', 'ðŸŽ¶', 'ðŸ’¯', 'ðŸ¤”', 'ðŸ˜Š', 'ðŸ˜­', 'ðŸ¤¯', 'ðŸ¥³',
                'ðŸ˜¢', 'ðŸ˜¡', 'ðŸ˜±', 'ðŸ¤©', 'ðŸ˜´', 'ðŸ¤ª', 'ðŸ¤«', 'ðŸ˜‡', 'ðŸ˜ˆ', 'ðŸ¤ ', 'ðŸ¤–', 'ðŸ’€', 'ðŸ‘½', 'ðŸ‘»', 'ðŸŽƒ', 'ðŸ˜º', 'ðŸ˜¸', 'ðŸ˜¹',
                'ðŸ‘‹', 'âœŒï¸', 'ðŸ‘Œ', ' ', 'ðŸ™Œ', 'ðŸ™', 'ðŸ’ª', ' ', 'ðŸ‘€', 'ðŸ‘„', 'ðŸ‘…', 'ðŸ‘‚', 'ðŸ‘ƒ', 'ðŸ¦¶', 'ðŸ¦¿', 'ðŸ«€', 'ðŸ¦·',
                'ðŸ¶', 'ðŸ±', 'ðŸ­', 'ðŸ¹', 'ðŸ°', 'ðŸ¦Š', 'ðŸ»', 'ðŸ¼', 'ðŸ¨', 'ðŸ¯', 'ðŸ¦', 'ðŸ®', 'ðŸ·', 'ðŸ¸', 'ðŸµ', 'ðŸ”', 'ðŸ¦', 'ðŸ¦‰',
                'ðŸ', 'ðŸŽ', 'ðŸ', 'ðŸŠ', 'ðŸ‹', 'ðŸŒ', 'ðŸ‰', ' ', 'ðŸ“', 'ðŸ’', 'ðŸ‘', 'ðŸ', 'ðŸ¥­', 'ðŸ¥¥', 'ðŸ¥', 'ðŸ…', 'ðŸ†',
                'ðŸ”', 'ðŸŸ', 'ðŸ•', 'ðŸŒ­', 'ðŸŒ®', 'ðŸŒ¯', 'ðŸœ', 'ðŸ', 'ðŸ£', 'ðŸ±', 'ðŸ›', 'ðŸš', 'ðŸ™', 'ðŸ˜', 'ðŸ¡', 'ðŸµ', 'â˜•ï¸',
                'âš½ï¸', 'ðŸ€', 'ðŸˆ', 'âš¾ï¸', 'ðŸ¥Ž', 'ðŸ', 'ðŸ‰', 'ðŸŽ±', 'ðŸ“', 'ðŸ¸', 'ðŸ’', 'ðŸ‘', 'ðŸ¹', 'ðŸŽ£', 'ðŸ¥Š', 'ðŸ¥‹', 'ðŸ›¹',
                'ðŸš—', 'ðŸš•', 'ðŸšŒ', 'ðŸŽï¸', 'ðŸš“', 'ðŸš‘', 'ðŸš’', 'ðŸšš', 'ðŸš›', 'ðŸšœ', 'ðŸ›µ', 'ðŸš²', 'âœˆï¸', 'ðŸš€', 'ðŸš', 'â›µï¸', 'ðŸ›¥ï¸',
                'âŒšï¸', 'ðŸ“±', 'ðŸ’»', 'ðŸ–¥ï¸', 'âŒ¨ï¸', 'ðŸ–¨ï¸', 'ðŸ–±ï¸', 'ðŸ“·', 'ðŸ“¹', 'ðŸ’¿', 'ðŸ’¾', 'ðŸ“¼', 'â˜Žï¸', 'ðŸ“Ÿ', 'ðŸ“ ', 'ðŸ”‹', 'ðŸ”Œ',
                'ðŸ’¡', 'ðŸ”¦', 'ðŸ•¯ï¸', 'ðŸ—‘ï¸', 'ðŸ›¢ï¸', 'ðŸ’¸', 'ðŸ’°', 'ðŸ’³', 'ðŸ’Ž', 'ðŸ”‘', 'ðŸ”', 'ðŸ”¨', 'ðŸ› ï¸', 'ðŸªš', 'ðŸ”«', 'ðŸ’£', 'ðŸ”ª',
            ];
            
            emojis.forEach(emoji => {
                const span = document.createElement('span');
                span.textContent = emoji;
                emojiPicker.appendChild(span);
            });

            emojiBtn.addEventListener('click', (e) => {
                e.preventDefault();
                emojiPicker.classList.toggle('hidden');
            });
            
            emojiPicker.addEventListener('click', (e) => {
                if (e.target.tagName === 'SPAN') {
                    messageInput.value += e.target.textContent;
                    emojiPicker.classList.add('hidden');
                    messageInput.focus();
                }
            });

            document.addEventListener('click', (e) => {
                if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
                    emojiPicker.classList.add('hidden');
                }
            });

            // --- Fungsionalitas Nama Pengguna ---
            function loadUsername() {
                const storedUsername = localStorage.getItem('myUsername');
                if (storedUsername) {
                    myUsername = storedUsername;
                    usernameInput.value = storedUsername;
                    usernameDisplay.textContent = `Nama Pengguna: ${storedUsername}`;
                    usernameInput.disabled = true;
                    saveUsernameBtn.disabled = true;
                    saveUsernameBtn.textContent = 'Nama Tersimpan';
                    saveUsernameBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                } else {
                    usernameDisplay.textContent = `Nama Pengguna: belum diatur`;
                    usernameInput.disabled = false;
                    saveUsernameBtn.disabled = false;
                }
            }

            saveUsernameBtn.addEventListener('click', () => {
                const newUsername = usernameInput.value.trim();
                if (newUsername) {
                    myUsername = newUsername;
                    localStorage.setItem('myUsername', newUsername);
                    usernameDisplay.textContent = `Nama Pengguna: ${myUsername}`;
                    showCustomMessage('Nama Disimpan', `Nama pengguna Anda telah diatur menjadi "${myUsername}".`);
                    usernameInput.disabled = true;
                    saveUsernameBtn.disabled = true;
                    saveUsernameBtn.textContent = 'Nama Tersimpan';
                    saveUsernameBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                } else {
                    showCustomMessage('Nama Tidak Valid', 'Nama pengguna tidak boleh kosong.');
                }
            });

            loadUsername();
            
            // --- Fungsionalitas PeerJS ---
            try {
                const storedPeerId = localStorage.getItem('myPeerId');
                peer = new Peer(storedPeerId || null, {
                    host: '0.peerjs.com',
                    secure: true,
                    port: 443
                });

                peer.on('open', (id) => {
                    myIdSpan.textContent = id;
                    if (!storedPeerId) {
                        localStorage.setItem('myPeerId', id);
                    }
                });

                // Mendengarkan koneksi data
                peer.on('connection', (newConn) => {
                    // Periksa apakah pengguna yang terhubung diizinkan
                    if (!approvedUsers.includes(newConn.peer)) {
                        showCustomMessage('Koneksi Ditolak', `Koneksi masuk dari ${newConn.peer} ditolak. Pengguna tidak disetujui.`);
                        setTimeout(() => {
                           newConn.close(); 
                        }, 500); // Tutup koneksi setelah memberi notifikasi
                        return;
                    }
                    setupNewChat(newConn);
                    showCustomMessage('Koneksi Baru!', `Koneksi masuk dari ${newConn.peer}.`);
                });
                
                // Mendengarkan panggilan masuk
                peer.on('call', (call) => {
                    // Periksa apakah pengguna yang terhubung diizinkan
                     if (!approvedUsers.includes(call.peer)) {
                        showCustomMessage('Panggilan Ditolak', `Panggilan dari ${call.peer} ditolak. Pengguna tidak disetujui.`);
                        setTimeout(() => {
                            call.close();
                        }, 500);
                        return;
                    }
                    // Tampilkan dialog untuk menerima atau menolak panggilan
                    callDialog.classList.remove('hidden');
                    callDialogContent.textContent = `Menerima panggilan dari ${call.metadata.senderName || 'teman'}. Jenis: ${call.metadata.type === 'video' ? 'video' : 'suara'}...`;

                    // Tangani tombol 'Terima'
                    answerCallBtn.onclick = () => {
                        callDialog.classList.add('hidden');
                        if (call.metadata.type === 'video') {
                            startVideoCall(call);
                        } else {
                            startVoiceCall(call);
                        }
                    };

                    // Tangani tombol 'Tolak'
                    declineCallBtn.onclick = () => {
                        callDialog.classList.add('hidden');
                        call.close();
                        showCustomMessage('Panggilan Ditolak', `Panggilan dari ${call.peer} telah ditolak.`);
                    };
                });

                peer.on('error', (err) => {
                    console.error('PeerJS Error:', err);
                    showCustomMessage('Kesalahan Koneksi', `Terjadi kesalahan saat terhubung: ${err.type}. Coba muat ulang halaman.`);
                });
            } catch (err) {
                console.error('PeerJS Initialization Error:', err);
                showCustomMessage('Kesalahan Inisialisasi', 'Gagal memuat pustaka PeerJS. Silakan coba lagi nanti.');
            }

            connectForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const peerId = peerIdInput.value.trim();
                if (!myUsername || myUsername === 'Anda') {
                    showCustomMessage('Nama Pengguna Diperlukan', 'Silakan atur nama pengguna Anda terlebih dahulu sebelum terhubung.');
                    return;
                }
                if (peerId && peerId !== peer.id) {
                    if (!approvedUsers.includes(peerId) && !isAdmin) { // Hanya izinkan koneksi jika pengguna disetujui atau jika Anda admin
                         showCustomMessage('Koneksi Ditolak', 'Pengguna ini tidak ada di daftar yang disetujui.');
                         return;
                    }
                    if (activeChats.has(peerId)) {
                        switchActiveChat(peerId);
                        showCustomMessage('Obrolan Sudah Ada', 'Anda sudah terhubung dengan pengguna ini. Mengalihkan ke obrolan.');
                        return;
                    }
                    const newConn = peer.connect(peerId);
                    setupNewChat(newConn);
                } else if (peerId === peer.id) {
                    showCustomMessage('ID Tidak Valid', 'Anda tidak dapat terhubung dengan diri sendiri!');
                }
            });

            messageForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const messageText = messageInput.value.trim();
                const currentChat = activeChats.get(currentChatId);
                
                if (messageText && currentChat && currentChat.conn.open) {
                    const messagePayload = { 
                        type: 'chat', 
                        content: messageText, 
                        senderName: myUsername, 
                        timestamp: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) 
                    };
                    currentChat.conn.send(messagePayload);
                    currentChat.messages.push(messagePayload);
                    addMessageToUI(messagePayload.senderName, messagePayload.content, messagePayload.timestamp, true);
                    saveChatHistory(currentChatId, currentChat.messages);
                    messageInput.value = '';
                }
            });

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                const currentChat = activeChats.get(currentChatId);
                if (!file) {
                    return;
                }
                
                const maxFileSize = 5 * 1024 * 1024;
                if (file.size > maxFileSize) {
                    showCustomMessage('Ukuran File Terlalu Besar', 'Ukuran file tidak boleh melebihi 5MB.');
                    fileInput.value = '';
                    return;
                }

                if (currentChat && currentChat.conn.open) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const base64String = event.target.result;
                        const filePayload = {
                            type: 'file',
                            fileName: file.name,
                            fileType: file.type,
                            content: base64String,
                            senderName: myUsername,
                            timestamp: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })
                        };
                        currentChat.conn.send(filePayload);
                        currentChat.messages.push(filePayload);
                        addFileToUI(filePayload.senderName, filePayload.fileName, base64String, filePayload.timestamp, true);
                        saveChatHistory(currentChatId, currentChat.messages);
                        fileInput.value = '';
                    };
                    reader.readAsDataURL(file);
                } else {
                    showCustomMessage('Koneksi Diperlukan', 'Silakan hubungkan ke teman sebelum mengirim file.');
                    fileInput.value = '';
                }
            });
            
            copyIdBtn.addEventListener('click', () => {
                const myId = myIdSpan.textContent;
                if (myId && myId !== 'Memuat...') {
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(myId).then(() => {
                            showCustomMessage('ID Disalin!', 'ID Anda telah disalin ke papan klip.');
                        }).catch(err => {
                            console.error('Failed to copy ID: ', err);
                        });
                    }
                }
            });
            
            exitChatBtn.addEventListener('click', () => {
                if (currentCall) {
                    endVoiceCall(); // Atau endVideoCall jika sedang dalam panggilan video
                }
                if (currentChatId) {
                    const chat = activeChats.get(currentChatId);
                    if (chat && chat.conn.open) {
                        chat.conn.close();
                        disableChat();
                        updateChatHeader(chat.username, 'offline', 'hubungan berakhir');
                        exitChatBtn.classList.add('hidden');
                        clearHistoryBtn.classList.add('hidden');
                        callBtn.classList.add('hidden');
                        videoCallBtn.classList.add('hidden');
                        hangupBtn.classList.add('hidden');
                    }
                }
            });
            
            clearHistoryBtn.addEventListener('click', () => {
                if (currentChatId) {
                    clearChatHistory(currentChatId);
                }
            });

            // --- Fungsionalitas Panggilan Suara ---
            callBtn.addEventListener('click', async () => {
                if (!currentChatId) {
                    showCustomMessage('Kontak Tidak Dipilih', 'Silakan pilih kontak dari daftar untuk memulai panggilan.');
                    return;
                }
                if (currentCall) {
                    showCustomMessage('Panggilan Sedang Berlangsung', 'Anda sudah berada dalam panggilan.');
                    return;
                }
                const currentChat = activeChats.get(currentChatId);
                if (!currentChat || !currentChat.conn.open) {
                    showCustomMessage('Koneksi Tidak Tersedia', 'Pastikan Anda terhubung ke teman Anda.');
                    return;
                }
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                    const call = peer.call(currentChatId, localStream, { metadata: { type: 'audio', senderName: myUsername } });
                    currentCall = call;
                    isVideoCall = false;
                    
                    call.on('stream', (remoteStream) => {
                        remoteAudio.srcObject = remoteStream;
                        remoteAudio.play();
                        updateChatHeader(currentChat.username, 'on-call', 'Dalam Panggilan Suara');
                        callBtn.classList.add('hidden');
                        videoCallBtn.classList.add('hidden');
                        hangupBtn.classList.remove('hidden');
                    });
                    call.on('close', () => {
                        endCall();
                        updateChatHeader(currentChat.username, 'online', 'Panggilan Suara Berakhir');
                    });
                    updateChatHeader(currentChat.username, 'on-call', 'Memanggil...');
                } catch (err) {
                    console.error('Gagal mendapatkan media atau memulai panggilan:', err);
                    showCustomMessage('Kesalahan Panggilan', 'Gagal mendapatkan akses mikrofon. Pastikan Anda memberikan izin.');
                }
            });

            // --- Fungsionalitas Panggilan Video ---
            videoCallBtn.addEventListener('click', async () => {
                if (!currentChatId) {
                    showCustomMessage('Kontak Tidak Dipilih', 'Silakan pilih kontak dari daftar untuk memulai panggilan video.');
                    return;
                }
                if (currentCall) {
                    showCustomMessage('Panggilan Sedang Berlangsung', 'Anda sudah berada dalam panggilan.');
                    return;
                }
                const currentChat = activeChats.get(currentChatId);
                if (!currentChat || !currentChat.conn.open) {
                    showCustomMessage('Koneksi Tidak Tersedia', 'Pastikan Anda terhubung ke teman Anda.');
                    return;
                }
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    localVideo.srcObject = localStream;
                    localVideo.play();
                    
                    const call = peer.call(currentChatId, localStream, { metadata: { type: 'video', senderName: myUsername } });
                    currentCall = call;
                    isVideoCall = true;

                    call.on('stream', (remoteStream) => {
                        remoteVideo.srcObject = remoteStream;
                        remoteVideo.play();
                        videoContainer.classList.remove('hidden');
                        videoContainer.classList.add('active');
                        updateChatHeader(currentChat.username, 'on-call', 'Dalam Panggilan Video');
                        callBtn.classList.add('hidden');
                        videoCallBtn.classList.add('hidden');
                        hangupBtn.classList.remove('hidden');
                    });
                    call.on('close', () => {
                        endCall();
                        updateChatHeader(currentChat.username, 'online', 'Panggilan Video Berakhir');
                    });

                    updateChatHeader(currentChat.username, 'on-call', 'Memanggil...');
                } catch (err) {
                    console.error('Gagal mendapatkan media atau memulai panggilan:', err);
                    showCustomMessage('Kesalahan Panggilan', 'Gagal mendapatkan akses kamera dan mikrofon. Pastikan Anda memberikan izin.');
                }
            });

            hangupBtn.addEventListener('click', () => {
                if (currentCall) {
                    currentCall.close();
                    endCall();
                }
            });

            function endCall() {
                if (currentCall) {
                    currentCall.close();
                }
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    localStream = null;
                }
                if (remoteAudio.srcObject) {
                    remoteAudio.srcObject.getTracks().forEach(track => track.stop());
                    remoteAudio.srcObject = null;
                }
                if (remoteVideo.srcObject) {
                    remoteVideo.srcObject.getTracks().forEach(track => track.stop());
                    remoteVideo.srcObject = null;
                }
                currentCall = null;
                localVideo.srcObject = null;
                remoteAudio.pause();
                remoteAudio.removeAttribute('srcObject');
                videoContainer.classList.add('hidden');
                videoContainer.classList.remove('active');
                hangupBtn.classList.add('hidden');
                callBtn.classList.remove('hidden');
                videoCallBtn.classList.remove('hidden');
                updateChatHeader(activeChats.get(currentChatId)?.username || 'Tidak ada obrolan', 'online', 'Panggilan Berakhir');
            }

            function startVoiceCall(call) {
                // Fungsi ini digunakan untuk menjawab panggilan masuk
                navigator.mediaDevices.getUserMedia({ audio: true, video: false })
                    .then(stream => {
                        localStream = stream;
                        currentCall = call;
                        call.answer(stream);
                        call.on('stream', (remoteStream) => {
                            remoteAudio.srcObject = remoteStream;
                            remoteAudio.play();
                            updateChatHeader(call.peer, 'on-call', 'Dalam Panggilan Suara');
                            callBtn.classList.add('hidden');
                            videoCallBtn.classList.add('hidden');
                            hangupBtn.classList.remove('hidden');
                        });
                        call.on('close', () => {
                            endCall();
                            updateChatHeader(call.peer, 'online', 'Panggilan Suara Berakhir');
                        });
                    })
                    .catch(err => {
                        console.error('Gagal mendapatkan media:', err);
                        showCustomMessage('Kesalahan Panggilan', 'Gagal mendapatkan akses mikrofon. Pastikan Anda memberikan izin.');
                    });
            }

            function startVideoCall(call) {
                 // Fungsi ini digunakan untuk menjawab panggilan masuk
                navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                    .then(stream => {
                        localStream = stream;
                        localVideo.srcObject = stream;
                        localVideo.play();
                        currentCall = call;
                        call.answer(stream);
                        call.on('stream', (remoteStream) => {
                            remoteVideo.srcObject = remoteStream;
                            remoteVideo.play();
                            videoContainer.classList.remove('hidden');
                            videoContainer.classList.add('active');
                            updateChatHeader(call.peer, 'on-call', 'Dalam Panggilan Video');
                            callBtn.classList.add('hidden');
                            videoCallBtn.classList.add('hidden');
                            hangupBtn.classList.remove('hidden');
                        });
                        call.on('close', () => {
                            endCall();
                            updateChatHeader(call.peer, 'online', 'Panggilan Video Berakhir');
                        });
                    })
                    .catch(err => {
                        console.error('Gagal mendapatkan media:', err);
                        showCustomMessage('Kesalahan Panggilan', 'Gagal mendapatkan akses kamera dan mikrofon. Pastikan Anda memberikan izin.');
                    });
            }

            function setupNewChat(newConn) {
                let chat = activeChats.get(newConn.peer);
                if (!chat) {
                    const history = chatHistory.get(newConn.peer) || [];
                    chat = {
                        conn: newConn,
                        username: newConn.peer,
                        messages: history,
                        status: 'connecting'
                    };
                    activeChats.set(newConn.peer, chat);
                } else {
                    chat.conn = newConn;
                    chat.status = 'connecting';
                }
                
                renderContacts();
                
                newConn.on('open', () => {
                    const chat = activeChats.get(newConn.peer);
                    chat.status = 'online';
                    
                    const handshakePayload = { 
                        type: 'handshake', 
                        content: `Halo, saya ${myUsername}!`,
                        senderName: myUsername,
                        timestamp: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })
                    };
                    chat.conn.send(handshakePayload);

                    addContact(newConn.peer, chat.username);
                    switchActiveChat(newConn.peer);
                });

                newConn.on('data', (data) => {
                    const chat = activeChats.get(newConn.peer);
                    
                    if (data.type === 'chat') {
                        chat.messages.push(data);
                        
                        const existingContact = contacts.find(contact => contact.id === newConn.peer);
                        if (existingContact && existingContact.username !== data.senderName) {
                            existingContact.username = data.senderName;
                            saveContacts();
                            renderContacts();
                        } else if (!existingContact) {
                            addContact(newConn.peer, data.senderName);
                        }
                        
                        if (currentChatId === newConn.peer) {
                             addMessageToUI(data.senderName, data.content, data.timestamp, false);
                        }
                    } else if (data.type === 'file') {
                        chat.messages.push(data);
                        if (currentChatId === newConn.peer) {
                            addFileToUI(data.senderName, data.fileName, data.content, data.timestamp, false);
                        }
                    } else if (data.type === 'handshake') {
                        const existingContact = contacts.find(contact => contact.id === newConn.peer);
                        if (existingContact) {
                            existingContact.username = data.senderName;
                            saveContacts();
                            renderContacts();
                        } else {
                            addContact(newConn.peer, data.senderName);
                        }
                    }
                    saveChatHistory(newConn.peer, chat.messages);
                });
                
                newConn.on('close', () => {
                    const chat = activeChats.get(newConn.peer);
                    if (chat) {
                        chat.status = 'offline';
                        if (currentChatId === newConn.peer) {
                            updateChatHeader(chat.username, 'offline', 'hubungan berakhir');
                            disableChat();
                            exitChatBtn.classList.add('hidden');
                            clearHistoryBtn.classList.add('hidden');
                            callBtn.classList.add('hidden');
                            videoCallBtn.classList.add('hidden');
                            hangupBtn.classList.add('hidden');
                        }
                    }
                });

                newConn.on('error', (err) => {
                    console.error('Connection Error:', err);
                    const chat = activeChats.get(newConn.peer);
                    if (chat) {
                        chat.status = 'offline';
                        if (currentChatId === newConn.peer) {
                            updateChatHeader(chat.username, 'offline', 'Koneksi gagal.');
                            disableChat();
                            exitChatBtn.classList.add('hidden');
                            clearHistoryBtn.classList.add('hidden');
                            callBtn.classList.add('hidden');
                            videoCallBtn.classList.add('hidden');
                            hangupBtn.classList.add('hidden');
                        }
                    }
                });
            }

            function switchActiveChat(peerId) {
                document.querySelectorAll('.contact-item').forEach(el => el.classList.remove('active'));
                const selectedContact = document.querySelector(`.contact-item[data-peer-id="${peerId}"]`);
                if (selectedContact) {
                    selectedContact.classList.add('active');
                }
                
                currentChatId = peerId;
                const chat = activeChats.get(peerId) || { messages: chatHistory.get(peerId) || [] };
                
                if (chat) {
                    updateChatHeader(chat.username || peerId, chat.status || 'offline');
                    chatMessages.innerHTML = '';
                    if (chat.messages.length > 0) {
                        chat.messages.forEach(msg => {
                            const isMyMessage = msg.senderName === myUsername;
                            if (msg.type === 'chat') {
                                addMessageToUI(msg.senderName, msg.content, msg.timestamp, isMyMessage);
                            } else if (msg.type === 'file') {
                                addFileToUI(msg.senderName, msg.fileName, msg.content, msg.timestamp, isMyMessage);
                            }
                        });
                    } else {
                        const div = document.createElement('div');
                        div.classList.add('text-center', 'text-gray-500', 'text-sm');
                        div.textContent = 'Mulai obrolan Anda.';
                        chatMessages.appendChild(div);
                    }
                    
                    if (chat.status === 'online') {
                        enableChat();
                        exitChatBtn.classList.remove('hidden');
                        clearHistoryBtn.classList.remove('hidden');
                        callBtn.classList.remove('hidden');
                        videoCallBtn.classList.remove('hidden');
                    } else {
                        disableChat();
                        exitChatBtn.classList.add('hidden');
                        clearHistoryBtn.classList.remove('hidden');
                        callBtn.classList.add('hidden');
                        videoCallBtn.classList.add('hidden');
                    }
                } else {
                    updateChatHeader('Tidak ada obrolan', 'offline', 'Pilih obrolan dari daftar kontak.');
                    disableChat();
                    exitChatBtn.classList.add('hidden');
                    clearHistoryBtn.classList.add('hidden');
                    callBtn.classList.add('hidden');
                    videoCallBtn.classList.add('hidden');
                }
            }
            
            function addMessageToUI(sender, message, timestamp, isMyMessage) {
                const messageWrapper = document.createElement('div');
                messageWrapper.classList.add('flex', 'mb-4', 'items-end', 'space-x-2');
                const messageContent = document.createElement('div');
                messageContent.classList.add('flex', 'flex-col');
                const messageBubble = document.createElement('div');
                messageBubble.classList.add('message-bubble', 'p-3', 'rounded-xl', 'shadow', 'break-words', 'whitespace-pre-line', 'max-w-full');
                
                const senderHtml = `<p class="font-bold text-xs sm:text-sm ${isMyMessage ? 'text-teal-200' : 'text-teal-600'}">${escapeHTML(sender)}</p>`;
                const messageHtml = `<p class="text-sm sm:text-base mt-1">${escapeHTML(message)}</p>`;
                messageBubble.innerHTML = senderHtml + messageHtml;
                
                const messageTimestamp = document.createElement('p');
                messageTimestamp.classList.add('text-xs', 'text-gray-400', 'mt-1');
                messageTimestamp.textContent = timestamp;
                if (isMyMessage) {
                    messageWrapper.classList.add('justify-end');
                    messageBubble.classList.add('bg-teal-500', 'text-white', 'ml-auto', 'mr-2');
                    messageContent.classList.add('items-end');
                    messageContent.appendChild(messageBubble);
                    messageContent.appendChild(messageTimestamp);
                    messageWrapper.appendChild(messageContent);
                } else {
                    messageWrapper.classList.add('justify-start');
                    messageBubble.classList.add('bg-gray-200', 'text-gray-800', 'mr-auto', 'ml-2');
                    messageContent.classList.add('items-start');
                    messageContent.appendChild(messageBubble);
                    messageContent.appendChild(messageTimestamp);
                    messageWrapper.appendChild(messageContent);
                }
                chatMessages.appendChild(messageWrapper);
                scrollToBottom();
            }

            function addFileToUI(sender, fileName, fileContent, timestamp, isMyMessage) {
                const messageWrapper = document.createElement('div');
                messageWrapper.classList.add('flex', 'mb-4', 'items-end', 'space-x-2');
                const messageContent = document.createElement('div');
                messageContent.classList.add('flex', 'flex-col');
                const fileBubble = document.createElement('div');
                fileBubble.classList.add('message-bubble', 'p-3', 'rounded-xl', 'shadow', 'flex', 'flex-col', 'items-center', 'space-y-2');
                let previewHtml = '';
                let fileType = fileName.split('.').pop().toLowerCase();
                const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'svg', 'webp'];
                if (imageExtensions.includes(fileType)) {
                    previewHtml = `<img src="${fileContent}" class="file-preview">`;
                } else {
                    previewHtml = `<p>File: ${escapeHTML(fileName)}</p>`;
                }
                const downloadLink = document.createElement('a');
                downloadLink.href = fileContent;
                downloadLink.download = fileName;
                downloadLink.classList.add('bg-teal-500', 'hover:bg-teal-600', 'text-white', 'font-semibold', 'px-3', 'py-1', 'rounded-md', 'text-xs', 'transition-colors', 'duration-200');
                downloadLink.textContent = 'Unduh';
                const senderText = document.createElement('p');
                senderText.classList.add('font-bold', 'text-xs', 'sm:text-sm', isMyMessage ? 'text-teal-200' : 'text-teal-600');
                senderText.textContent = escapeHTML(sender);
                fileBubble.appendChild(senderText);
                fileBubble.innerHTML += previewHtml;
                fileBubble.appendChild(downloadLink);
                const messageTimestamp = document.createElement('p');
                messageTimestamp.classList.add('text-xs', 'text-gray-400', 'mt-1');
                messageTimestamp.textContent = timestamp;
                if (isMyMessage) {
                    messageWrapper.classList.add('justify-end');
                    fileBubble.classList.add('bg-teal-500', 'text-white');
                    messageContent.classList.add('items-end');
                    messageContent.appendChild(fileBubble);
                    messageContent.appendChild(messageTimestamp);
                    messageWrapper.appendChild(messageContent);
                } else {
                    messageWrapper.classList.add('justify-start');
                    fileBubble.classList.add('bg-gray-200', 'text-gray-800');
                    messageContent.classList.add('items-start');
                    messageContent.appendChild(fileBubble);
                    messageContent.appendChild(messageTimestamp);
                    messageWrapper.appendChild(messageContent);
                }
                chatMessages.appendChild(messageWrapper);
                scrollToBottom();
            }
            
            function enableChat() {
                messageInput.disabled = false;
                sendButton.disabled = false;
                emojiBtn.disabled = false;
                fileInput.disabled = false;
                messageInput.focus();
            }

            function disableChat() {
                messageInput.disabled = true;
                sendButton.disabled = true;
                emojiBtn.disabled = true;
                fileInput.disabled = true;
            }

            function scrollToBottom() {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            function escapeHTML(str) {
                const div = document.createElement('div');
                div.appendChild(document.createTextNode(str));
                return div.innerHTML;
            }
            
            function updateChatHeader(username, state, message = '') {
                const dotClass = state === 'online' ? 'bg-online' : (state === 'connecting' ? 'bg-connecting' : (state === 'on-call' ? 'bg-blue-500' : 'bg-offline'));
                const statusMessage = message || (state === 'online' ? 'Terhubung' : (state === 'connecting' ? 'Menghubungkan...' : (state === 'on-call' ? 'Dalam Panggilan' : 'Tidak terhubung')));
                
                chatStatusDot.classList.remove('bg-online', 'bg-connecting', 'bg-offline', 'bg-blue-500');
                chatStatusDot.classList.add(dotClass);
                chatStatusText.textContent = `${username || 'Pilih obrolan'} - ${statusMessage}`;
            }

            function showCustomMessage(title, content) {
                messageBoxTitle.textContent = title;
                messageBoxContent.textContent = content;
                messageBox.classList.remove('hidden');
            }

            messageBoxCloseBtn.addEventListener('click', () => {
                messageBox.classList.add('hidden');
            });
        });
    </script>
</body>
</html>
 